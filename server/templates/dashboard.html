<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitor Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metrics-table {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .refresh-btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>System Monitor Dashboard</h1>
            <div class="button-group">
                <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-container">
                <h3>CPU Usage Over Time</h3>
                <canvas id="cpuChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Memory Usage Over Time</h3>
                <canvas id="memoryChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Disk Usage Over Time</h3>
                <canvas id="diskChart"></canvas>
            </div>
        </div>

        <div class="metrics-table">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Recent Metrics</h3>
                <button class="clear-btn" onclick="clearMetrics()" style="background-color: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                    Clear All Metrics
                </button>
            </div>
            <table id="metricsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>CPU %</th>
                        <th>Memory %</th>
                        <th>Disk %</th>
                        <th>User</th>
                        <th>Computer</th>
                        <th>OS</th>
                        <th>IP Address</th>
                    </tr>
                </thead>
                <tbody id="metricsBody">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let cpuChart, memoryChart, diskChart;

        async function loadData() {
            try {
                const response = await fetch('/metrics');
                const metrics = await response.json();
                
                updateCharts(metrics);
                updateTable(metrics);
            } catch (error) {
                console.error('Error loading metrics:', error);
                alert('Error loading metrics. Please make sure the server is running.');
            }
        }

        function updateCharts(metrics) {
            const timestamps = metrics.map(m => m.timestamp);
            const cpuData = metrics.map(m => m.cpu_usage);
            const memoryData = metrics.map(m => m.memory_usage);
            const diskData = metrics.map(m => m.disk_usage);

            // CPU Chart
            if (cpuChart) cpuChart.destroy();
            cpuChart = new Chart(document.getElementById('cpuChart'), {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: cpuData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Memory Chart
            if (memoryChart) memoryChart.destroy();
            memoryChart = new Chart(document.getElementById('memoryChart'), {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Memory Usage (%)',
                        data: memoryData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Disk Chart
            if (diskChart) diskChart.destroy();
            diskChart = new Chart(document.getElementById('diskChart'), {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Disk Usage (%)',
                        data: diskData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updateTable(metrics) {
            const tbody = document.getElementById('metricsBody');
            tbody.innerHTML = '';

            metrics.forEach(metric => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${metric.timestamp}</td>
                    <td>${metric.cpu_usage}%</td>
                    <td>${metric.memory_usage}%</td>
                    <td>${metric.disk_usage}%</td>
                    <td>${metric.user_name}</td>
                    <td>${metric.computer_name}</td>
                    <td>${metric.os}</td>
                    <td>${metric.ip_address}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function clearMetrics() {
            if (confirm('Are you sure you want to clear all metrics? This action cannot be undone.')) {
                try {
                    const response = await fetch('/clear-metrics', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        alert(result.message);
                        loadData(); // Refresh the data to show empty state
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error clearing metrics:', error);
                    alert('Error clearing metrics. Please make sure the server is running.');
                }
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
